<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG 戰鬥系統範例</title>
    <style> </style>
</head>
<body>

    <div id="battle-container">
        <div id="battle-interface">
            <div id="enemy-area">
                <p>哥布林</p> <div class="hp-bar-container">
                    <div class="hp-bar" id="enemy-hp-bar" style="width: 100%;"></div>
                </div>
                <p id="enemy-hp-text">HP: 120/120</p>
            </div>

            <div id="player-section">
                <div id="player-character-area">
                    <img id="player-character-img" src="C:\Users\UUN\OneDrive\圖片\Screenshots\螢幕擷取畫面 2025-04-10 230633.png" alt="勇者艾爾">
                    <img id="slash-effect" src="C:\Users\UUN\Downloads\pngtree-ink-japanese-samurai-wielding-a-sword-png-image_2829791.jpg" alt="斬擊特效">
                </div>

                <div id="player-panel">
                    <div class="player-grid">
                        <button id="attack-button" class="grid-item action-button">斬擊</button>
                        <div id="hp-status" class="grid-item status-display">
                            <span>HP</span>
                            <div class="hp-bar-container">
                                <div class="hp-bar" id="player-hp-bar" style="width: 100%;"></div>
                            </div>
                            <span id="player-hp-text">100/100</span>
                        </div>

                        <button id="skill1-button" class="grid-item action-button">火球術 (MP 10)</button>
                        <div id="mp-status" class="grid-item status-display">
                            <span>MP</span>
                            <div class="mp-bar-container">
                                <div class="mp-bar" id="player-mp-bar" style="width: 100%;"></div>
                            </div>
                            <span id="player-mp-text">50/50</span>
                        </div>

                        <button id="skill2-button" class="grid-item action-button">治療術 (MP 15)</button>
                        <button id="bag-button" class="grid-item action-button">背包</button>
                    </div>
                </div>
            </div> </div> <div id="message-log">戰鬥開始！</div>

    </div> <script>
        // --- DOM Element References ---
        const attackButton = document.getElementById('attack-button');
        const skill1Button = document.getElementById('skill1-button');
        const skill2Button = document.getElementById('skill2-button');
        const bagButton = document.getElementById('bag-button');

        const playerHpBar = document.getElementById('player-hp-bar');
        const playerHpText = document.getElementById('player-hp-text');
        const playerMpBar = document.getElementById('player-mp-bar');
        const playerMpText = document.getElementById('player-mp-text');

        const enemyHpBar = document.getElementById('enemy-hp-bar');
        const enemyHpText = document.getElementById('enemy-hp-text');

        const messageLog = document.getElementById('message-log');

        // Animation Elements
        const playerImage = document.getElementById('player-character-img');
        const slashEffect = document.getElementById('slash-effect');

        // --- Game Data (Simplified) ---
        let player = {
            name: "勇者艾爾",
            maxHp: 100,
            currentHp: 100,
            maxMp: 50,
            currentMp: 50,
            attackPower: 15,
            skills: [
                { name: "火球術", mpCost: 10, damage: 25, type: 'damage' },
                { name: "治療術", mpCost: 15, heal: 30, type: 'heal' }
            ]
        };

        let enemy = {
            name: "哥布林",
            maxHp: 120,
            currentHp: 120,
            attackPower: 10,
            defense: 5
        };

        let isPlayerTurn = true;
        let battleEnded = false;

        // --- UI Update Function ---
        function updateUI() {
            if (battleEnded) return;

            // Player HP
            const playerHpPercent = Math.max(0, (player.currentHp / player.maxHp) * 100);
            playerHpBar.style.width = playerHpPercent + '%';
            playerHpText.textContent = `${player.currentHp}/${player.maxHp}`;

            // Player MP
            const playerMpPercent = Math.max(0, (player.currentMp / player.maxMp) * 100);
            playerMpBar.style.width = playerMpPercent + '%';
            playerMpText.textContent = `${player.currentMp}/${player.maxMp}`;

            // Enemy HP
            const enemyHpPercent = Math.max(0, (enemy.currentHp / enemy.maxHp) * 100);
            enemyHpBar.style.width = enemyHpPercent + '%';
            enemyHpText.textContent = `HP: ${enemy.currentHp}/${enemy.maxHp}`;

            // Update button states based on turn and resources
            attackButton.disabled = !isPlayerTurn;
            skill1Button.disabled = !isPlayerTurn || player.currentMp < player.skills[0].mpCost;
            skill2Button.disabled = !isPlayerTurn || player.currentMp < player.skills[1].mpCost;
            bagButton.disabled = !isPlayerTurn; // Bag usually usable on player turn
        }

        // --- Message Logging ---
        function logMessage(message) {
            // Add timestamp for clarity (optional)
            // const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            // messageLog.innerHTML = `[${time}] ${message}<br>` + messageLog.innerHTML;
            messageLog.innerHTML = message + '<br>' + messageLog.innerHTML;
            messageLog.scrollTop = 0; // Scroll to top to see latest message
            console.log(message); // Also log to console for debugging
        }

        // --- Animation Trigger Function ---
        function triggerAttackAnimation() {
            if (playerImage.classList.contains('player-attacking-lunge')) {
                return; // Don't restart if already animating
            }
            playerImage.classList.add('player-attacking-lunge');
            slashEffect.classList.add('slash-effect-active');

            // Remove classes after animation finishes (use longest duration)
            setTimeout(() => {
                playerImage.classList.remove('player-attacking-lunge');
                slashEffect.classList.remove('slash-effect-active');
            }, 300); // Duration of player-lunge animation
        }

        // --- Battle Logic Functions ---

        function playerTurnAction(actionFn) {
            if (!isPlayerTurn || battleEnded) return;
            isPlayerTurn = false; // Start action, player can't act again yet
            updateUI(); // Disable buttons immediately

            actionFn(); // Execute the specific action (attack, skill, bag)

            // Check for battle end after player action
             if (checkBattleEnd()) return;


            // If battle continues, delay enemy turn
            logMessage("..."); // Pause indicator
            setTimeout(enemyTurn, 1500); // Delay for enemy turn (1.5 seconds)
        }


        function playerAttack() {
             logMessage(`${player.name} 發動了斬擊！`);
             triggerAttackAnimation(); // Trigger animation

             const damage = Math.max(1, player.attackPower - enemy.defense);
             enemy.currentHp = Math.max(0, enemy.currentHp - damage);
             logMessage(`對 ${enemy.name} 造成了 ${damage} 點傷害。`);
             updateUI(); // Update UI immediately after damage calculation
        }

        function playerUseSkill(skillIndex) {
            const skill = player.skills[skillIndex];

            if (player.currentMp >= skill.mpCost) {
                player.currentMp -= skill.mpCost;
                logMessage(`${player.name} 使用了 ${skill.name}！ (消耗 ${skill.mpCost} MP)`);

                // TODO: Add skill animations here

                if (skill.type === 'damage') {
                    const damage = skill.damage; // Simplified, add defense calc later
                    enemy.currentHp = Math.max(0, enemy.currentHp - damage);
                    logMessage(`對 ${enemy.name} 造成了 ${damage} 點傷害。`);
                } else if (skill.type === 'heal') {
                    const healAmount = skill.heal;
                    player.currentHp = Math.min(player.maxHp, player.currentHp + healAmount);
                    logMessage(`${player.name} 恢復了 ${healAmount} 點 HP。`);
                }
                 updateUI(); // Update UI after skill effect
            } else {
                logMessage("MP 不足，無法使用此技能！");
                // If MP is insufficient, it shouldn't cost the turn.
                 isPlayerTurn = true; // Give turn back immediately
                 updateUI(); // Re-enable buttons
                 // Exit the playerTurnAction flow early
                 // This requires slightly restructuring playerTurnAction or adding flags.
                 // For simplicity now, let's assume insufficient MP still passes the turn.
                 // A better approach would handle this without passing the turn.
            }
        }

        function openBag() {
            logMessage(`${player.name} 打開了背包... (功能待實現)`);
            // Implement inventory logic here
            // For now, let's assume opening bag doesn't immediately end the turn,
            // or maybe using an item does.
             isPlayerTurn = true; // TEMPORARY: Give turn back immediately
             updateUI();
        }

        function enemyTurn() {
             if (battleEnded) return;
            logMessage(`輪到 ${enemy.name} 的回合！`);

            // Simple AI: Attack
            // TODO: Add enemy attack animation
            const damage = Math.max(1, enemy.attackPower); // Simplified, add player defense calc later
            player.currentHp = Math.max(0, player.currentHp - damage);
            logMessage(`${enemy.name} 攻擊！${player.name} 受到了 ${damage} 點傷害。`);

            updateUI();

            if (checkBattleEnd()) return;


            // End enemy turn, back to player
            isPlayerTurn = true;
            logMessage(`輪到 ${player.name} 了。`);
            updateUI(); // Re-enable player buttons
        }


        function checkBattleEnd() {
            if (enemy.currentHp <= 0) {
                logMessage(`擊敗了 ${enemy.name}！戰鬥勝利！ 🎉`);
                battleEnded = true;
                isPlayerTurn = false; // No more turns
                updateUI(); // Disable all buttons permanently
                return true; // Battle ended
            } else if (player.currentHp <= 0) {
                logMessage(`${player.name} 的 HP 歸零... 戰鬥失敗...`);
                battleEnded = true;
                isPlayerTurn = false; // No more turns
                updateUI(); // Disable all buttons permanently
                return true; // Battle ended
            }
             return false; // Battle continues
        }


        // --- Event Listeners ---
        attackButton.addEventListener('click', () => playerTurnAction(playerAttack));
        skill1Button.addEventListener('click', () => playerTurnAction(() => playerUseSkill(0)));
        skill2Button.addEventListener('click', () => playerTurnAction(() => playerUseSkill(1)));
        bagButton.addEventListener('click', () => playerTurnAction(openBag));


        // --- Initial Setup ---
        logMessage("戰鬥介面初始化...");
        document.addEventListener('DOMContentLoaded', () => {
            updateUI(); // Initial UI setup when DOM is ready
            logMessage(`遭遇 ${enemy.name}！輪到 ${player.name} 了。`);
        });


    </script>

</body>
</html>